//------------------------------------------------
//--- 010 Editor v12.0.1 Binary Template
//
//      File: 
//   Authors: HenryVIII
//   Version: 
//   Purpose: Parsing Silent Hill 4 data container
//  Category: Modding
// File Mask: .bin
//  ID Bytes: 
//   History: 
//------------------------------------------------
LittleEndian();
local uint64 savepoint<hidden=true>;
local uint64 checkpoint<hidden=true>;
local uint64 i<hidden=true>;
local uint64 j<hidden=true>;
local uint64 k<hidden=true>;


struct MeshHeader
{
    uint32 unk_id;// should be 03 00 ff ff
    uint32 unk_num;
    uint32 matrix_1_ofc;
    uint32 matrix_1_num;
    uint32 matrix_1_data_ofc;
    uint32 matrix_2_num;
    uint32 matrix_2_data_ofc;
    uint32 matrix_2_ofc;
    uint32 num_meshes;
    uint32 mesh_ofc;
    uint32 unk_00;
    uint32 block_size;// size of linked meshes
    uint32 unk_num_04;
    uint32 unk_ofc_04;
    uint32 unk_num_05;
    uint32 unk_ofc_05;
    uint32 unk_val;
    uint32 unk_num_06;
    uint32 unk_ofc_06;
    uint32 unk_num_07;
    uint32 unk_ofc_07;
    uint32 unk_04[3];
    uint32 floats_ofc;
    uint16 unk_05[6];
    uint32 unk_ofc;
    uint32 unk_06[3];
};

struct Matrix4x4
{
    float val[16];
};

struct UnkMatrix
{
    float val[24];
};

struct UnkBlock01
{
    float unk_00[16];
};

struct UnkBlock02
{
    uint32 unk_00[3];
};

struct UnkBlock03
{
    uint32 unk_00;
};

struct UnkBlock04
{
    uint32 unk_00[2];
};

struct UnkBlock05
{
    uint16 unk_00[3];
};

struct UnkAdrsBlock
{
    uint32 unk_num;
    uint32 unk_ofc;
};

struct UnkAdrsBlockBody
{
    uint16 unk_num[4];
};


struct UnkFloats00
{
    float unk_float[32];
};

struct MeshBlock
{
  uint32 mesh_size<fgcolor=0x103090>;
  uint32 unk_null_00;
  uint32 unk_ofc_00;
  uint32 unk_00[15];
  float unk_float[17]<fgcolor=0x108010>;
  uint32 unk_01[12];
  uint32 unk_nulls[16];
  uint32 unk_num_indexes<fgcolor=cRed>;
  uint32 unk_num_floats;
  uint32 unk_num_00;
  uint32 unk_num_01;
  uint32 unk_ofc_01;
  uint32 unk_ofc_02;
  uint32 unk_ofc_03;
  UnkBlock01 unk_floats[unk_num_floats]<fgcolor=0x008080>;  
  uint16 unk_indexes[unk_num_indexes]<fgcolor=0x805010>;
  uint32 unk_ints[unk_num_01]<fgcolor=0x105080>;
};

struct TestMeshBlock
{
    uint32 mesh_size<fgcolor=0x103090>;
    uint32 unk_null_00;
    uint32 unk_ofc_00;
    uint32 unk_00;
    uint32 unk_01;
    uint32 unk_02;
    uint32 unk_03; // offset
    uint32 unk_03;
};


//parsing
uint32 num_ofc<fgcolor=cRed>;
uint32 ofc_00[num_ofc]<fgcolor=0x008000>;
FSeek(ofc_00[0]);
savepoint = FTell();
MeshHeader mesh_header<fgcolor=0x808000>;
if (mesh_header.unk_id == 4294901763)
{
    //matrices 1
    FSeek(mesh_header.matrix_1_ofc + savepoint);
    Matrix4x4 matrices[mesh_header.matrix_1_num]<fgcolor=cGreen>;
    //matrices 2
    FSeek(mesh_header.matrix_2_ofc + savepoint);
    Matrix4x4 matrices_2[mesh_header.matrix_2_num]<fgcolor=0x303090>;
    
    FSeek(mesh_header.matrix_1_data_ofc + savepoint);
    ubyte unk_matrix_1_data[mesh_header.matrix_1_num]<fgcolor=cYellow>;
    
    FSeek(mesh_header.matrix_2_data_ofc + savepoint);
    uint16 unk_matrix_2_data[mesh_header.matrix_2_num]<fgcolor=cBlue>;
    
    FSeek(mesh_header.unk_ofc_04 + savepoint);
    UnkBlock03 unk_block_04[mesh_header.unk_num_04]<fgcolor=0x8030a0>;
    
    FSeek(mesh_header.unk_ofc_05 + savepoint);
    UnkBlock04 unk_block_05[mesh_header.unk_num_05]<fgcolor=0xa05080>;
    
    FSeek(mesh_header.unk_ofc_06 + savepoint);
    UnkBlock05 unk_block_06[mesh_header.unk_num_06]<fgcolor=0xa0a080>;
    
    FSeek(mesh_header.unk_ofc_07 + savepoint);
    checkpoint = FTell();
    struct{
        for(i=0; i<(mesh_header.unk_num_07); i++)
        {
            FSeek(checkpoint);
            UnkAdrsBlock unk_adrs_block_header<fgcolor=0xa050c0>;
            checkpoint = FTell();
            FSeek(unk_adrs_block_header[i].unk_ofc + savepoint);
            struct {
                for(j=0; j<(unk_adrs_block_header[i].unk_num); j++)
                {
                    UnkAdrsBlockBody unk_adrs_body<fgcolor=0xc010c0>;
                };
            }adrs_body;
    
        };
    }unk_data_block_07;
    
    // unk floats
    FSeek(mesh_header.floats_ofc + savepoint);
    UnkFloats00 unk_floats<fgcolor=0x80a010>;
    // meshes
    FSeek(mesh_header.mesh_ofc + savepoint);
    savepoint = FTell();
    
    for(k=0; k<(mesh_header.num_meshes); k++)
    {
        FSeek(savepoint);
        savepoint = FTell();
        MeshBlock test_mesh;  
        //TestMeshBlock test_mesh;
        //FSeek(savepoint + test_mesh[k].unk_ofc_00);
        //uint32 test<fgcolor=0x80a010>;
        //FSeek(savepoint + test_mesh[k].unk_03);
        //uint32 test_01<fgcolor=0x40c010>;
        savepoint = savepoint + test_mesh[k].mesh_size;
    };
};
